#!/usr/bin/env bash
set -e

mkdir --parents /etc/avahi
SHORT_HOSTNAME="$(hostname -s)" envsubst < /etc/avahi/avahi-daemon.conf.template > /etc/avahi/avahi-daemon.conf

AVAHI_IMAGE=quay.io/celebdor/avahi:f29
if ! podman inspect "$AVAHI_IMAGE" &>/dev/null; then
    (>&2 echo "Pulling avahi release image...")
    podman pull "$AVAHI_IMAGE"
fi

# Check if the pod exists
MATCHES="$(sudo podman ps -a --format "{{.Names}}" | awk '/avahi$/ {print $0}')"
if [[ -z "$MATCHES" ]]; then
    podman create \
            --name avahi \
            --volume /etc/avahi:/etc/avahi:z \
            --network=host \
            "${AVAHI_IMAGE}"
fi
